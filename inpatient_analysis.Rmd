---
title: "inpatient_analysis"
output: html_document
---

```{r} 

# ── 1. Read raw data ─────────────────────────────────────────────────────────

library(tidyverse)
library(janitor)
library(lubridate)
library(glue)
```

```{r}

# ── 2. Drop columns that are 100 % NA (log them) ────────────────────────────

inpt_claims_raw <- read_csv("data/Inpatient_Claims.csv")

before_cols <- names(inpt_claims_raw)

inpt_claims <- inpt_claims_raw %>%
  remove_constant(na.rm = FALSE)

after_cols <- names(inpt_claims)

removed <- setdiff(before_cols, after_cols)
if (length(removed) > 0) {
  message(glue(
    "Removed columns: {paste(removed, collapse = ', ')}"
    ))
} else {
  message("No constant columns removed.")
}

```
 
```{r}

# ── 3. Standardize names & basic types ──────────────────────────────────────

inpt_claims <- inpt_claims %>%
  clean_names() %>%
  mutate(
    admit_date     = ymd(as.character(clm_admsn_dt)),
    from_date      = ymd(as.character(clm_from_dt)),
    thru_date      = ymd(as.character(clm_thru_dt)),
    discharge_date = ymd(as.character(nch_bene_dschrg_dt)),
    drg_code       = factor(clm_drg_cd),
  )

```

```{r}

# ── 4. Identify a bill-type column, if present ──────────────────────────────

preferred_bill_vars <- c("bill_type", "clm_type_cd", "tob")

bill_type_vars <- preferred_bill_vars[preferred_bill_vars %in% names(inpt_claims)]


if (length(bill_type_vars) == 0) {
  
  # No bill type → infer final claims by presence of discharge date
  inpt_claims <- inpt_claims %>%
    mutate(is_final = !is.na(discharge_date))
  
} else {
  
  # Use the first preferred column as the authoritative source
  primary_bt <- bill_type_vars[1]
  
  # If there’s a second column, check that it matches (after padding)
  if (length(bill_type_vars) == 2) {
    secondary_bt <- bill_type_vars[2]
    
    agree <- all(
      str_pad(inpt_claims[[primary_bt]], 3, pad = "0") ==
        str_pad(inpt_claims[[secondary_bt]], 3, pad = "0"),
      na.rm = TRUE
    )
    
    if (!agree) 
      warning(glue(
        "Bill-type columns '{primary_bt}' and '{secondary_bt}' ",
        "do not match for at least one record...please investigate."
      )
    )
  }
  
  # Create final-claim flag from the primary column
  inpt_claims <- inpt_claims %>%
    mutate(
      bill_type_chr = str_pad(as.character(!!sym(primary_bt)), 3, pad = "0"),
      tob_last      = substr(bill_type_chr, 3, 3),
      is_final      = tob_last %in% c("1", "4", "7")
    )
}

```

```{r}

# ── 5. Calculate Length-of-Stay (LOS) ───────────────────────────────────────

inpt_claims <- inpt_claims %>%
  mutate(
    los = case_when(
      is_final & !is.na(discharge_date)             ~ as.integer(discharge_date - admit_date),
      is_final &  is.na(discharge_date)             ~ as.integer(thru_date - admit_date),  # final but discharge missing
      TRUE                                          ~ NA_integer_                           # interim claim, leave blank
    )
  )

```

